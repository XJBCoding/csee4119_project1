#!/usr/bin/env python
from socket import socket, AF_INET, SOCK_STREAM
import time

import sys
if __name__ == '__main__':
    print(sys.argv)
    listen_port = sys.argv[1]
    fake_ip = sys.argv[2]
    server_ip = sys.argv[3]
    #listen_port = "8080"
    #fake_ip = "127.0.0.1"
    #server_ip = "127.0.0.1"
    poll = []
    proxySocket = socket(AF_INET, SOCK_STREAM)
    serverSocket = socket(AF_INET, SOCK_STREAM)
    proxySocket.bind(('', int(listen_port)))
    proxySocket.listen(1)
    print('The proxy is ready to receive')

    while True:
        clientSocket, _ = proxySocket.accept()
        poll.append(clientSocket)
        while len(poll):
            print(poll)
            currentSocket = poll.pop(0)
            while True:
                sentence = currentSocket.recv(1024)
                if len(sentence) < 0:
                    break
                serverSocket.connect((server_ip, 8080))
                serverSocket.send(sentence)
                response = serverSocket.recv(1024)
                if len(response) < 0:
                    break
                currentSocket.send(response)
            print('current connection end.')
            currentSocket.close()
            serverSocket.close()
    proxySocket.close()