#!/usr/bin/env python
from socket import socket, AF_INET, SOCK_STREAM
import time

import sys
if __name__ == '__main__':
    print(sys.argv)
    listen_port = sys.argv[1]
    fake_ip = sys.argv[2]
    server_ip = sys.argv[3]
    poll = []
    proxySocket = socket(AF_INET, SOCK_STREAM)
    proxySocket.bind(('', int(listen_port)))
    proxySocket.listen(1)
    print('The proxy is ready to receive')
    while True:
        clientSocket, _ = proxySocket.accept()
        poll.append(clientSocket)
        while len(poll):
            try:
                serverSocket = socket(AF_INET, SOCK_STREAM) 
                serverSocket.connect((server_ip,8080))
            except:
                pass 
            currentSocket = poll.pop(0)
            try:
                while True:
                    sentence = currentSocket.recv(1024)
                    if len(sentence) < 0:
                        break
                    serverSocket.send(sentence)
                    response = serverSocket.recv(1024)
                    if len(response) < 0:
                        break
                    currentSocket.send(response)
            except Exception as e:
                print(e)
                currentSocket.close()
                serverSocket.close()
            print('current connection down')
    #proxySocket.close()
